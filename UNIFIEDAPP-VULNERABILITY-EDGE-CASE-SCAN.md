# UnifiedApp – Vulnerability & Edge Case Scan Report

**Scan date:** 2025-01-30  
**Scope:** `UnifiedApp/src` (ThiaMobile, GlobalHealth, BBSCART, shared)

This document lists issues that can cause runtime crashes or undefined behavior, plus recommended mitigations.

---

## 1. Fixes Applied This Scan

### 1.1 Missing `useSafeAreaInsets()` (Render Error: "Property 'insets' doesn't exist")

**Fixed files:**
- **SaveCardAndUPI.js** – Imported `useSafeAreaInsets` but never called it; `insets` was used in `contentContainerStyle`. Added `const insets = useSafeAreaInsets();` at top of component.
- **RewardsScreen.js** – Same issue. Added `const insets = useSafeAreaInsets();` at top of component.

**Previously fixed:** UserAccount.js (same pattern).

### 1.2 Unsafe `res.data` Array Usage (API Returns Non-Array)

**Fixed:**
- **HomeScreen.js (ThiaMobile)** – Two `useEffect` blocks used `res.data.forEach(...)` without checking that `res.data` is an array. Replaced with: `const list = Array.isArray(res?.data) ? res.data : res?.data?.products || res?.data?.items || [];` then `list.forEach(...)`.
- **EmergencyScreen.js (GlobalHealth)** – `res.data.map(...)` could throw if `res.data` is undefined or non-array. Replaced with: `const data = Array.isArray(res?.data) ? res.data : res?.data?.data || res?.data?.logs || [];` then `data.map(...)`.
- **MedicalVaultScreen.js (GlobalHealth)** – `res.data.sort(...)` could throw and mutates the array. Replaced with: copy array then sort: `const raw = Array.isArray(res?.data) ? res.data : res?.data?.data || res?.data?.records || [];` and `const sorted = [...raw].sort(...)`.

### 1.3 Optional Chaining for API Response

**Fixed:**
- **UserAccount.js** – `res.data.name` and `res.data.email` could throw if `res.data` is undefined (e.g. 200 with empty or error body). Changed to `res.data?.name` and `res.data?.email`.

### 1.4 Undefined Property Access (Deeplink)

**Fixed:**
- **HomeScreen.js** – `onBannerPress`: `item.deeplink.split(':')` throws if `item.deeplink` is undefined. Replaced with `const deeplink = item?.deeplink || '';` then `deeplink.split(':')`.

---

## 2. Remaining Risks & Recommendations

### 2.1 Safe Area Insets

- **Recommendation:** For any new screen that uses `insets.top` / `insets.bottom` in styles, ensure `const insets = useSafeAreaInsets();` is called at the top of the component (no conditional before it).
- **Hook rule:** Do not call `useSafeAreaInsets()` after an early `return`; hooks must run in the same order every render.

### 2.2 API Response Handling

- **Pattern to avoid:** `res.data.forEach`, `res.data.map`, `res.data.sort`, or direct `res.data.property` when the API might return non-array or empty/error payloads.
- **Safer pattern:**  
  - For arrays: `const list = Array.isArray(res?.data) ? res.data : res?.data?.products || res?.data?.items || [];` then use `list`.  
  - For objects: use `res?.data?.field` and provide defaults.
- **Files to review for similar issues:** Any screen that does `setX(res.data)` or `res.data.xyz` without optional chaining or array checks (e.g. DigitalHealthCardScreen, AIDiseasePredictionRiskEngine, PatientFeedbackEngine, FamilyHealthTimeline, CarePassScannerScreen). Prefer `res?.data` and fallbacks.

### 2.3 JSON.parse Without Try/Catch

- **Risk:** Corrupted or non-JSON data in AsyncStorage causes `JSON.parse()` to throw and can crash the app.
- **Where:** UserAccount.js (cached user), Notifications.js, ProfileSettingsScreen.js, CheckoutScreen.js, Wishlist.js, AppSettingsScreen.js, and other screens that load from AsyncStorage.
- **Recommendation:** Prefer wrapping `JSON.parse(storageValue)` in try/catch and falling back to a default (e.g. `{}`, `[]`, or null). Some files already have try/catch (e.g. Notifications, AppSettingsScreen); extend this pattern everywhere storage is parsed.

### 2.4 Navigation

- **Pattern in use:** Many screens use `navigation.navigate(...)` or `navigation.replace(...)` without checking `navigation` or `navigation.navigate`. Deep links or certain flows might render a screen without navigation.
- **Recommendation:** For screens that might be mounted without a navigator, use `navigation?.navigate?.(...)` or guard: `if (navigation?.navigate) navigation.navigate(...)`.

### 2.5 Array / String Access

- **Patterns that can throw:**  
  - `arr[0]` or `arr[0].prop` when `arr` is empty or undefined.  
  - `str.split(...)` when `str` is undefined.  
  - `p.images[0].split('|')[0]` when `p.images` is empty or missing (optional chaining used in some places; ensure consistent use).
- **Recommendation:** Use optional chaining and defaults: `(item?.deeplink || '').split(':')`, `array?.[0]`, `(res?.data || [])`.

### 2.6 Dependency Array & Stale Closures

- **useEffect / useCallback:** Some effects depend on `navigation` or other props but omit them from the dependency array. This can cause stale behavior (e.g. navigating to wrong screen or using old token). Add required deps where appropriate; for `navigation`, React Navigation usually guarantees stability.

### 2.7 Security / Sensitive Data

- **Tokens:** Tokens are read from AsyncStorage and sent in headers. Ensure no token or PII is logged in production (e.g. `console.log(res.data)`).
- **Card/UPI:** SaveCardAndUPI.js already notes: never store raw card data/CVV; use tokenization and follow PCI/RBI guidelines.

---

## 3. Quick Reference – Files Touched This Scan

| File | Change |
|------|--------|
| `thiamobile/screens/SaveCardAndUPI.js` | Added `const insets = useSafeAreaInsets();` |
| `thiamobile/screens/RewardsScreen.js` | Added `const insets = useSafeAreaInsets();` |
| `thiamobile/screens/HomeScreen.js` | Safe array usage for PRODUCTS_TRENDING & PRODUCTS_DEALS; safe `item.deeplink` in onBannerPress |
| `thiamobile/screens/UserAccount.js` | `res.data?.name`, `res.data?.email` |
| `globalhealth/screens/EmergencyScreen.js` | Safe array for `res.data` before `.map()` |
| `globalhealth/screens/MedicalVaultScreen.js` | Safe array copy before `.sort()` |

---

## 4. Suggested Next Steps

1. **Audit all screens** that use `insets` in styles and confirm each has `const insets = useSafeAreaInsets();` at the top level (no hook after conditional return).
2. **Standardize API handling:** In every axios/fetch handler, use `res?.data` and normalize arrays with `Array.isArray(res?.data) ? res.data : res?.data?.products || []` (or equivalent) before calling `.forEach`, `.map`, `.sort`.
3. **Wrap JSON.parse:** For every `JSON.parse(AsyncStorage.getItem(...))`, use try/catch and a safe default.
4. **Optional navigation:** In screens that may be used without a navigator, use `navigation?.navigate?.(...)`.
5. **Remove or guard logs:** Avoid logging full API responses or tokens in production.

This scan focused on runtime crashes and obvious undefined-access patterns; a full security and penetration review would require additional checks (auth flows, input validation, certificate pinning, etc.).
